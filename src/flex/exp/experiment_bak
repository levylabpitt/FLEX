# experiment.py
import uuid
from datetime import datetime
from flex.db import FLEXDB
from  .script_to_db import CellLogger
from IPython import get_ipython

class Experiment:
    def __init__(self, user, notes="", enable_cell_log=True):
        if enable_cell_log and get_ipython():
            self.cell_logger = CellLogger(self)
        self.session_id = uuid.uuid4()
        self.user = user
        self.notes = [notes] if notes else []
        self.start_time = datetime.now()
        self.end_time = None
        self.instruments = {}
        self.measurements = []

        self.db = FLEXDB(dbname="levylab_test", username='llab_admin')
        print(f"[{self.start_time}] Experiment started: {self.session_id}")
        self._log_start_to_db()

    def _log_start_to_db(self):
        sql = """
            INSERT INTO exp (id, username, start_time, end_time, instruments)
            VALUES (%s, %s, %s, %s, %s)
        """
        self.db.execute_fetch(
            sql_string=sql,
            params=(str(self.session_id), self.user, self.start_time, None, []),
            method='none'
        )

    def init(self, cls, name=None, *args, **kwargs):
        name = name or cls.__name__
        if name in self.instruments:
            raise ValueError(f"Instrument '{name}' already initialized.")
        self.instruments[name] = cls(*args, **kwargs)
        return self.instruments[name]

    def new_measurement(self, notes=""):
        return Measurement(self, notes=notes)

    def end(self):
        self.end_time = datetime.now()
        self._update_end_time()
        if hasattr(self, "cell_logger"):
            self.cell_logger.unregister()
        self.db.close_connection()
        print(f"[{self.end_time}] Experiment ended and saved.")

    def _update_end_time(self):
        sql = """
            UPDATE exp SET end_time = %s, instruments = %s
            WHERE id = %s
        """
        self.db.execute_fetch(
            sql_string=sql,
            params=(self.end_time, list(self.instruments.keys()), str(self.session_id)),
            method='none'
        )

    def _log_to_db(self):
        sql = """
            INSERT INTO exp (id, username, start_time, end_time, instruments)
            VALUES (%s, %s, %s, %s, %s)
        """
        self.db.execute_fetch(
            sql_string=sql,
            params=(str(self.session_id), self.user, self.start_time, self.end_time, list(self.instruments.keys())),
            method=None  # no fetch
        )
        print(f"Experiment {self.session_id} logged to DB.")


class Measurement:
    def __init__(self, experiment, notes=""):
        self.experiment = experiment
        self.experiment_id = experiment.session_id
        self.notes = [notes] if notes else []
        self.start_time = None
        self.end_time = None

    def __enter__(self):
        self.start_time = datetime.now()
        print(f"[{self.start_time}] Measurement started.")
        return self

    def add_note(self, note):
        self.notes.append(f"{datetime.now().isoformat()}: {note}")
    
    def __exit__(self, exc_type, exc_value, traceback):
        self.end()

    def end(self):
        self.end_time = datetime.now()
        self._log_to_db()
        print(f"[{self.end_time}] Measurement ended and logged.")

    def _log_to_db(self):
        sql = """
            INSERT INTO meas (id, experiment_id, start_time, end_time, notes)
            VALUES (%s, %s, %s, %s, %s)
        """
        self.experiment.db.execute_fetch(
            sql_string=sql,
            params=(str(uuid.uuid4()), str(self.experiment_id),
                    self.start_time, self.end_time, self.notes),
            method='none'  # no fetch
        )
